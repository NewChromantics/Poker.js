<!DOCTYPE html>
<html>
	<title>Bad Beat - Poker.js test app</title>
	<link rel="icon" href="Joker.svg" sizes="any" type="image/svg+xml">
	<head>
		<script src="https://newchromantics.github.io/PlayingCard.WebComponent/playing-card.js" type=module></script>
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<style>
			:root
			{
				/* 3.5 inches x 2.5 inches */
				--cardWidth: 30pt;
				--cardHeight: calc( var(--cardWidth) * 1.4 );
			}
			
			html
			{
				color:	#eee;
				font-family: sans-serif;
				font-weight: bold;
				font-size: 10pt;
				
				background: #23bad9 url(HatchBackground.svg);
			}
						
			
			#BoardContainer
			{
				padding: 10pt;
				background:	rgba(0,0,0,0.3);
				border-radius: 10pt;
				margin: 10pt;
			}
			
			#Board
			{
				min-height: calc( var(--cardHeight) * 1.2 );
			}
			
			#BestHandCards
			{
				xxdisplay:none;
			}
			
			#BestHandName,
			#BestHandScore
			{
				display: inline-block;
			}
			
			#Pile
			{
				/* center all the cards in the div */
				display: flex;
				flex-direction: row;
				justify-content: center;
				flex-wrap: wrap;
			}
			
		</style>
	</head>
	<body>
		<playing-card image="Joker.svg"></playing-card>
		<playing-card></playing-card>
		<playing-card suit="Club"></playing-card>
		<playing-card suit="$" rank=2></playing-card>
		<div id=BoardContainer>
			<label>Board</label>
			<div id=Board>
				<!--<div class="Card Static" Rank="-1"></div>-->
				<playing-card class="Static" onclick="MoveRandomCardToBoard(this)"></playing-card>
			</div>
			<label>Best Hand</label>
			<div id=BestHandCards></div>
			<div id=BestHandName></div>
			<div id=BestHandScore></div>
			<!--
			<Label>Nuts</label>
			<div id=NutsCards></div>
			-->
		</div>
		
		<div id=Pile></div>
		
		<script type=module>
			import * as Poker from './Poker.js'
			
			//	run unit tests by importing
			import * as UnitTest from './UnitTest.js'
			
			function RattleCard(CardDiv)
			{
				if ( !CardDiv )
					return;

				//	to re-trigger a once-shot animation tied to a class, remove old class and add it again.
				//	but, we need a frame in-between otherwise it's a no-op
				//	this means there's a 1 frame delay before doing the animation, which is... fine?
				function AddRattle()
				{
					CardDiv.classList.add('RattleOnce');
				}
				CardDiv.classList.remove('RattleOnce');
				requestAnimationFrame(AddRattle);
			}
			
			function MoveRandomCardToBoard(TriggerCard)
			{
				RattleCard(TriggerCard);
				
				const PileCardDivs = GetPileCardDivs();
				if ( PileCardDivs.length == 0 )
					return;
					
				const RandomCard = PileCardDivs[Math.floor(Math.random()*PileCardDivs.length)];
				AddToBoard( RandomCard, true );
			}
			window.MoveRandomCardToBoard = MoveRandomCardToBoard;
			
			function GetCardMeta(CardDiv)
			{
				const Suit = CardDiv.getAttribute('suit');
				const Rank = CardDiv.getAttribute('rank');
				return new Poker.Card(Suit,Rank);
			}
			
			function GetBoardCardDivs()
			{
				return Array.from( document.querySelectorAll(`#Board playing-card[suit]`) );
			}
			
			function GetPileCardDivs()
			{
				return Array.from( document.querySelectorAll(`#Pile playing-card[suit]`) );
			}
			
			function GetBoardCardMetas()
			{
				const CardDivs = GetBoardCardDivs();
				const CardMetas = CardDivs.map( GetCardMeta );
				return CardMetas;
			}
			
			
			function GetPileCardMetas()
			{
				const CardDivs = GetPileCardDivs();
				const CardMetas = CardDivs.map( GetCardMeta );
				return CardMetas;
			}
			
			function GetBoardBestHand()
			{
				const Cards = GetBoardCardMetas();
				//	get new score
				try
				{
					const Hand = Poker.GetScoringHand(Cards);
					return Hand;
				}
				catch(e)
				{
					const Type = `Error: ${e}`;
					return new Poker.Hand([],Type,0);
				}
			}
			
			function OnBoardChanged()
			{
				const BestHand = GetBoardBestHand();
				const BestHandCardsDiv = document.querySelector(`#BestHandCards`);
				const BestHandNameDiv = document.querySelector(`#BestHandName`);
				const BestHandScoreDiv = document.querySelector(`#BestHandScore`);
				
				const NewCardDivs = BestHand.Cards.map( c => MakeCardDiv(c,false,["SmallCard"]) );
				
				const BestHandScore = Poker.GetBestHandScore();
				const ScorePercent = Math.ceil( (BestHand.Score / BestHandScore) * 100 );
				const ScoreText = `${ScorePercent}% (${BestHand.Score}/${BestHandScore})`;
				
				BestHandCardsDiv.replaceChildren(...NewCardDivs);
				BestHandNameDiv.innerText = BestHand.Type;
				BestHandScoreDiv.innerText = ScoreText;
				
				//	make sure anything in the pile isn't marked as scoring
				const PileCardDivs = GetPileCardDivs();
				PileCardDivs.forEach( c => c.classList.remove('ScoringCard') );

				//	highlight the scoring cards
				const BoardCardDivs = GetBoardCardDivs();
				function IsScoringCard(CardDiv)
				{
					return BestHand.Cards.find( cm => GetCardMeta(CardDiv).Equals(cm) );
				}
				function UpdateScoringCardClass(CardDiv)
				{
					CardDiv.classList.remove('ScoringCard')
					if ( IsScoringCard(CardDiv) )
						CardDiv.classList.add('ScoringCard')
				}
				BoardCardDivs.forEach(UpdateScoringCardClass);
			}
			
			function OnCardClicked(CardDiv)
			{
				if ( CardDiv.parentElement == Pile )
				{
					AddToBoard(CardDiv);
				}
				else if ( CardDiv.parentElement == Board )
				{
					AddToPile(CardDiv);
				}
			}
			
			
			function MakeCardDiv(CardMeta,Clickable,Classes=[])
			{
				if ( CardMeta.RepresentCard )
					CardMeta = CardMeta.RepresentCard;
				
				const CardDiv = document.createElement(`playing-card`);
				CardDiv.classList.add(...Classes);
				CardDiv.setAttribute('rank',CardMeta.Rank);
				CardDiv.setAttribute('suit',CardMeta.Suit);
				if ( Clickable === true )
				{
					CardDiv.setAttribute('onclick','');
					CardDiv.onclick = () => { OnCardClicked(CardDiv); };
				}
				//CardDiv.innerText = "x";
				return CardDiv;
			}
			
			function AddToPile(CardDiv)
			{
				Pile.appendChild(CardDiv);
				OnBoardChanged();
			}
			
			function AddToBoard(CardDiv,InsertAtBeginning=false)
			{
				const NonStaticBoardCards = Board.querySelectorAll(`.Card:not(.Static)`);
				const FirstChild = NonStaticBoardCards[0];
				if ( InsertAtBeginning && FirstChild )
					Board.insertBefore(CardDiv,FirstChild);
				else
					Board.appendChild(CardDiv);
				OnBoardChanged();
			}
			
			function LoadDeck()
			{
				function MakeCard(CardMeta)
				{
					const Card = MakeCardDiv(CardMeta,true);
					AddToPile(Card);
				}
				const Jokers = Poker.GetJokerCards(5);
				Jokers.forEach( MakeCard );
				const Cards = Poker.GetAllCards();
				Cards.forEach( MakeCard );
			}
			
			LoadDeck();
			
		</script>
		
		
	</body>
</html>

